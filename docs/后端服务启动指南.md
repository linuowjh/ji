# 后端服务启动指南

## ✅ 服务已成功启动！

后端服务现在正在运行：
- **地址**: http://localhost:8080
- **健康检查**: http://localhost:8080/health
- **API文档**: http://localhost:8080/api/v1

## 🔧 启动步骤

### 1. 确保环境配置正确

检查 `.env` 文件是否存在并配置正确：

```bash
# 查看配置
cat .env
```

关键配置项：
- `SERVER_PORT=8080` - 服务器端口
- `MYSQL_HOST` - MySQL主机地址
- `MYSQL_PORT` - MySQL端口
- `MYSQL_USERNAME` - MySQL用户名
- `MYSQL_PASSWORD` - MySQL密码
- `MYSQL_DATABASE` - 数据库名称

### 2. 启动服务

```bash
# 方式1：直接运行（开发模式）
go run cmd/server/main.go

# 方式2：编译后运行（生产模式）
go build -o bin/server cmd/server/main.go
./bin/server
```

### 3. 验证服务

```bash
# 健康检查
curl http://localhost:8080/health

# 预期输出
{
  "message": "云念纪念馆服务运行正常",
  "status": "ok",
  "version": "1.0.0"
}
```

## 📋 服务状态

### 当前运行状态

- ✅ MySQL连接成功
- ⚠️ Redis连接失败（服务在无缓存模式下运行）
- ✅ HTTP服务器启动成功
- ✅ 所有API路由已注册

### 数据库连接

```
MySQL: sh-cynosdbmysql-grp-80bx7aey.sql.tencentcdb.com:26835
数据库: yun_nian_memorial
状态: ✅ 已连接
```

### Redis连接（可选）

```
Redis: localhost:6379
状态: ⚠️ 未连接（服务仍可正常运行）
```

## 🚀 API端点

### 认证相关
- `POST /api/v1/auth/login` - 微信登录
- `POST /api/v1/auth/refresh` - 刷新Token
- `GET /api/v1/auth/profile` - 获取用户信息

### 纪念馆相关
- `GET /api/v1/memorials` - 获取纪念馆列表
- `POST /api/v1/memorials` - 创建纪念馆
- `GET /api/v1/memorials/:id` - 获取纪念馆详情
- `PUT /api/v1/memorials/:id` - 更新纪念馆
- `DELETE /api/v1/memorials/:id` - 删除纪念馆

### 祭扫相关
- `POST /api/v1/worship` - 创建祭扫记录
- `GET /api/v1/worship/memorial/:memorial_id` - 获取纪念馆祭扫记录

### 家族圈相关
- `GET /api/v1/families` - 获取家族列表
- `POST /api/v1/families` - 创建家族
- `GET /api/v1/families/:id` - 获取家族详情

### 更多API
查看完整API文档：http://localhost:8080/api/v1

## 🔧 命令行选项

服务器支持以下命令行选项：

### 数据库迁移

```bash
# 执行数据库迁移
go run cmd/server/main.go -migrate

# 迁移并插入种子数据
go run cmd/server/main.go -migrate -seed

# 重置数据库（危险操作！）
go run cmd/server/main.go -reset
```

### 种子数据

```bash
# 只插入种子数据
go run cmd/server/main.go -seed
```

## 🐛 常见问题

### 1. MySQL连接失败

**错误**: `Failed to connect to MySQL: dial tcp xxx: connection refused`

**解决方案**:
1. 检查MySQL服务是否运行
2. 确认 `.env` 文件中的MySQL配置正确
3. 检查网络连接和防火墙设置

### 2. Redis连接失败

**错误**: `Failed to connect to Redis: dial tcp 127.0.0.1:6379: connection refused`

**解决方案**:
- Redis是可选的，服务会在无缓存模式下继续运行
- 如需使用Redis，请安装并启动Redis服务：
  ```bash
  # macOS
  brew install redis
  brew services start redis
  
  # Ubuntu
  sudo apt-get install redis-server
  sudo systemctl start redis
  ```

### 3. 端口被占用

**错误**: `bind: address already in use`

**解决方案**:
1. 修改 `.env` 中的 `SERVER_PORT`
2. 或者停止占用8080端口的进程：
   ```bash
   # 查找占用端口的进程
   lsof -i :8080
   
   # 停止进程
   kill -9 <PID>
   ```

### 4. 环境变量未加载

**问题**: 服务使用默认配置而不是 `.env` 中的配置

**解决方案**:
- 确保 `.env` 文件在项目根目录
- 检查文件权限
- 确认代码中已加载 `godotenv.Load()`

## 📊 性能监控

### 查看日志

服务器会输出详细的日志信息：
- SQL查询日志
- HTTP请求日志
- 错误日志

### 监控指标

可以通过以下方式监控服务：
- 健康检查端点：`/health`
- 系统统计：`/api/v1/admin/stats`（需要管理员权限）

## 🔄 重启服务

### 开发模式

如果代码有更新，需要重启服务：

```bash
# 停止当前服务（Ctrl+C）
# 重新启动
go run cmd/server/main.go
```

### 生产模式

使用进程管理工具（如systemd、supervisor）：

```bash
# 使用systemd
sudo systemctl restart yunnian-server

# 使用supervisor
supervisorctl restart yunnian-server
```

## 📝 配置小程序

现在后端服务已启动，需要配置小程序连接后端：

### 1. 修改小程序API地址

编辑 `miniprogram/utils/api.js`：

```javascript
// 开发环境
const BASE_URL = 'http://localhost:8080/api/v1'

// 或者使用你的实际IP地址（用于真机调试）
// const BASE_URL = 'http://192.168.x.x:8080/api/v1'
```

### 2. 配置开发者工具

在微信开发者工具中：
1. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
2. 这样可以在开发阶段使用localhost

### 3. 测试连接

在小程序中测试API连接：
```javascript
wx.request({
  url: 'http://localhost:8080/health',
  success: (res) => {
    console.log('后端连接成功:', res.data)
  }
})
```

## ✅ 验证清单

启动后检查：

- [ ] 服务器启动成功，监听8080端口
- [ ] MySQL连接成功
- [ ] 健康检查接口返回正常
- [ ] 可以访问API端点
- [ ] 小程序可以连接后端（如果已配置）

## 🎯 下一步

1. ✅ 后端服务已启动
2. ✅ 数据库已连接
3. ✅ API已就绪
4. 📱 配置小程序连接后端
5. 🧪 开始测试功能
6. 🚀 开发新功能

**后端服务运行正常！** 🎉

## 📞 获取帮助

如果遇到问题：
1. 查看服务器日志
2. 检查 `.env` 配置
3. 测试健康检查接口
4. 查看数据库连接状态
