# 数据库日志配置说明

## 问题描述

启动服务时会输出大量SQL语句，影响日志可读性：

```
2025/11/14 16:20:50 /Users/k/dev/self/ji/internal/database/mysql.go:30
[28.547ms] [rows:-] SELECT * FROM `family_members` LIMIT 1
2025/11/14 16:20:50 /Users/k/dev/self/ji/internal/database/mysql.go:30
[57.562ms] [rows:-] SELECT column_name, column_default...
...（大量SQL日志）
```

## 原因

GORM的日志级别设置为 `Info` 模式，会输出所有SQL语句。

## 解决方案

### 1. 配置日志级别

在 `.env` 文件中添加配置：

```bash
# MySQL数据库配置
MYSQL_LOG_LEVEL=error  # 日志级别: silent, error, warn, info
```

### 2. 日志级别说明

| 级别 | 说明 | 输出内容 |
|------|------|----------|
| `silent` | 静默模式 | 不输出任何SQL日志 |
| `error` | 错误模式（推荐） | 只输出SQL错误 |
| `warn` | 警告模式 | 输出警告和错误 |
| `info` | 信息模式 | 输出所有SQL语句（调试用） |

### 3. 不同环境的推荐配置

#### 开发环境
```bash
MYSQL_LOG_LEVEL=error  # 只看错误，保持日志清爽
```

#### 调试SQL问题时
```bash
MYSQL_LOG_LEVEL=info   # 查看所有SQL语句
```

#### 生产环境
```bash
MYSQL_LOG_LEVEL=error  # 只记录错误
```

## 配置示例

### 完整的 .env 配置

```bash
# 服务器配置
SERVER_PORT=8080
GIN_MODE=debug

# MySQL数据库配置
MYSQL_HOST=sh-cynosdbmysql-grp-80bx7aey.sql.tencentcdb.com
MYSQL_PORT=26835
MYSQL_USERNAME=root
MYSQL_PASSWORD=12345678Qa
MYSQL_DATABASE=yun_nian_memorial
MYSQL_LOG_LEVEL=error  # 推荐设置

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# JWT配置
JWT_SECRET=your_jwt_secret_key_here
JWT_EXPIRE_TIME=604800

# 微信小程序配置
WECHAT_APP_ID=wx6b1f01efe1bed4a5
WECHAT_APP_SECRET=your_wechat_app_secret
```

## 应用配置

配置修改后需要重启服务：

```bash
# 停止当前服务（Ctrl+C）
# 重新启动
go run cmd/server/main.go
```

## 效果对比

### 修改前（info级别）
```
[GIN-debug] Listening and serving HTTP on :8080
2025/11/14 16:20:50 [28.547ms] [rows:-] SELECT * FROM `family_members` LIMIT 1
2025/11/14 16:20:50 [57.562ms] [rows:-] SELECT column_name FROM information_schema...
2025/11/14 16:20:50 [58.057ms] [rows:1] SELECT SCHEMA_NAME from Information_schema...
2025/11/14 16:20:50 [57.480ms] [rows:-] SELECT count(*) FROM INFORMATION_SCHEMA...
...（数百行SQL日志）
```

### 修改后（error级别）
```
[GIN-debug] Listening and serving HTTP on :8080
2025/11/14 16:45:22 云念纪念馆服务启动中，端口: 8080
2025/11/14 16:45:22 健康检查: http://localhost:8080/health
2025/11/14 16:45:22 API文档: http://localhost:8080/api/v1
[GIN-debug] Listening and serving HTTP on :8080
```

清爽多了！只有在SQL执行出错时才会输出日志。

## 临时调试

如果需要临时查看SQL日志，可以：

### 方法1：修改环境变量
```bash
# 临时设置
export MYSQL_LOG_LEVEL=info
go run cmd/server/main.go
```

### 方法2：修改.env文件
```bash
# 编辑 .env
MYSQL_LOG_LEVEL=info

# 重启服务
go run cmd/server/main.go

# 调试完成后改回
MYSQL_LOG_LEVEL=error
```

## 其他日志配置

### Gin框架日志

Gin的日志级别通过 `GIN_MODE` 控制：

```bash
# 开发模式（详细日志）
GIN_MODE=debug

# 发布模式（简洁日志）
GIN_MODE=release
```

### 应用日志

应用自身的日志可以通过Go的标准库控制：

```go
// 在main.go中
import "log"

// 设置日志格式
log.SetFlags(log.LstdFlags | log.Lshortfile)

// 只在开发环境输出详细日志
if os.Getenv("GIN_MODE") == "debug" {
    log.Println("详细调试信息")
}
```

## 最佳实践

### 1. 开发环境
- `MYSQL_LOG_LEVEL=error` - 保持日志清爽
- `GIN_MODE=debug` - 查看HTTP请求详情
- 需要调试SQL时临时改为 `info`

### 2. 生产环境
- `MYSQL_LOG_LEVEL=error` - 只记录错误
- `GIN_MODE=release` - 减少日志输出
- 使用专业的日志收集工具（如ELK）

### 3. 性能测试
- `MYSQL_LOG_LEVEL=silent` - 完全关闭SQL日志
- 避免日志输出影响性能测试结果

## 常见问题

### Q1: 为什么启动时还是有很多日志？

A: 启动时的日志主要是：
- Gin路由注册信息（正常）
- 数据库迁移检查（正常）
- 如果设置为 `error` 级别，不会输出SQL语句

### Q2: 如何完全关闭所有日志？

A: 
```bash
MYSQL_LOG_LEVEL=silent
GIN_MODE=release
```

但不推荐，至少保留错误日志。

### Q3: 日志太多影响性能吗？

A: 
- `info` 级别会影响性能（大量IO操作）
- `error` 级别几乎无影响
- 生产环境建议使用 `error` 或 `silent`

## 总结

- ✅ 已添加 `MYSQL_LOG_LEVEL` 配置
- ✅ 默认设置为 `error` 级别
- ✅ 可以根据需要灵活调整
- ✅ 保持日志清爽，提高开发效率

**推荐配置**: `MYSQL_LOG_LEVEL=error` 🎯
