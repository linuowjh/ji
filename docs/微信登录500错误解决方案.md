# 微信登录500错误解决方案

## 🔍 问题分析

### 错误现象
```bash
POST /api/v1/auth/wechat-login
返回: 500 Internal Server Error
```

### 错误原因

查看 `.env` 文件中的微信配置：
```bash
WECHAT_APP_ID=wx6b1f01efe1bed4a5
WECHAT_APP_SECRET=your_wechat_app_secret  # ❌ 这是占位符，不是真实的Secret
```

**问题**：
1. `WECHAT_APP_SECRET` 使用的是占位符，不是真实的AppSecret
2. 后端调用微信API时，微信服务器返回 `invalid appid` 错误
3. 服务捕获到错误后返回500状态码

### 错误流程

```
小程序 → 后端 → 微信API
         ↓
    使用错误的AppSecret
         ↓
    微信API返回错误
         ↓
    后端返回500错误
```

## ✅ 解决方案

### 方案1：配置真实的微信小程序凭证（推荐）

#### 1. 获取微信小程序凭证

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" → "开发管理" → "开发设置"
3. 找到"开发者ID"部分：
   - **AppID (小程序ID)**：已有 `wx6b1f01efe1bed4a5`
   - **AppSecret (小程序密钥)**：点击"生成"或"重置"获取

#### 2. 更新环境变量

编辑 `.env` 文件：

```bash
# 微信小程序配置
WECHAT_APP_ID=wx6b1f01efe1bed4a5
WECHAT_APP_SECRET=你的真实AppSecret  # 替换为从微信公众平台获取的AppSecret
```

#### 3. 重启后端服务

```bash
# 停止当前服务（Ctrl+C或关闭终端）
# 重新启动
go run cmd/server/main.go
```

#### 4. 测试登录

在小程序中测试登录功能，应该可以正常工作了。

### 方案2：使用测试模式（开发阶段）

如果暂时没有真实的AppSecret，可以修改代码跳过微信验证（仅用于开发测试）：

#### 修改 `internal/services/user_service.go`

```go
// WechatLogin 微信小程序登录
func (s *UserService) WechatLogin(req *WechatLoginRequest) (*WechatLoginResponse, error) {
	// 开发模式：跳过微信验证
	if s.config.Wechat.AppSecret == "your_wechat_app_secret" || s.config.Wechat.AppSecret == "" {
		return s.devModeLogin(req)
	}
	
	// 正常的微信登录流程
	// ... 原有代码
}

// devModeLogin 开发模式登录（仅用于测试）
func (s *UserService) devModeLogin(req *WechatLoginRequest) (*WechatLoginResponse, error) {
	// 使用code作为openid（测试用）
	openID := "test_" + req.Code
	
	var user models.User
	var isNewUser bool

	err := s.db.Where("wechat_openid = ?", openID).First(&user).Error
	if err != nil {
		if err == gorm.ErrRecordNotFound {
			// 创建测试用户
			user = models.User{
				ID:           uuid.New().String(),
				WechatOpenID: openID,
				Nickname:     req.Nickname,
				AvatarURL:    req.Avatar,
				Status:       1,
			}
			if err := s.db.Create(&user).Error; err != nil {
				return nil, fmt.Errorf("创建用户失败: %v", err)
			}
			isNewUser = true
		} else {
			return nil, fmt.Errorf("查询用户失败: %v", err)
		}
	}

	token, err := s.generateJWT(user.ID)
	if err != nil {
		return nil, fmt.Errorf("生成token失败: %v", err)
	}

	return &WechatLoginResponse{
		Token:     token,
		User:      user,
		IsNewUser: isNewUser,
	}, nil
}
```

**⚠️ 警告**：方案2仅用于开发测试，生产环境必须使用真实的微信凭证！

## 🧪 测试验证

### 1. 测试接口可访问性

```bash
curl -X POST http://localhost:8080/api/v1/auth/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code":"test_code"}'
```

**配置正确后的响应**：
```json
{
  "code": 0,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user_id",
      "nickname": "用户昵称",
      "avatar": "头像URL"
    },
    "is_new_user": true
  }
}
```

### 2. 在小程序中测试

```javascript
// 在小程序中调用
wx.login({
  success: res => {
    wx.request({
      url: 'http://localhost:8080/api/v1/auth/wechat-login',
      method: 'POST',
      data: { 
        code: res.code,
        nickname: '测试用户',
        avatar: 'https://example.com/avatar.jpg'
      },
      success: response => {
        if (response.data.code === 0) {
          console.log('登录成功:', response.data.data)
          // 保存token
          wx.setStorageSync('token', response.data.data.token)
        } else {
          console.error('登录失败:', response.data.message)
        }
      }
    })
  }
})
```

## 📋 错误码说明

| 错误码 | 说明 | 解决方案 |
|--------|------|----------|
| 500 | 服务器内部错误 | 检查AppSecret配置 |
| 1005 | 微信登录失败: invalid appid | 配置正确的AppSecret |
| 1005 | 微信登录失败: invalid code | code已过期或已使用 |
| 1001 | 请求参数错误 | 检查请求参数格式 |

## 🔐 微信AppSecret安全说明

### 重要提示

1. **不要泄露AppSecret**
   - AppSecret是敏感信息
   - 不要提交到Git仓库
   - 不要在前端代码中使用

2. **定期更换**
   - 建议定期更换AppSecret
   - 更换后需要重启服务

3. **环境隔离**
   - 开发环境和生产环境使用不同的AppSecret
   - 使用不同的 `.env` 文件

### .gitignore配置

确保 `.env` 文件已添加到 `.gitignore`：

```bash
# 环境变量文件
.env
.env.local
.env.*.local
```

## 🎯 完整配置检查清单

- [ ] 获取真实的微信AppSecret
- [ ] 更新 `.env` 文件中的 `WECHAT_APP_SECRET`
- [ ] 重启后端服务
- [ ] 测试登录接口
- [ ] 在小程序中测试登录
- [ ] 验证Token生成
- [ ] 测试需要认证的API

## 📞 常见问题

### Q1: 如何获取AppSecret？

A: 登录微信公众平台 → 开发 → 开发管理 → 开发设置 → 开发者ID → AppSecret（小程序密钥）

### Q2: AppSecret重置后会影响什么？

A: 
- 旧的AppSecret立即失效
- 需要更新 `.env` 配置
- 需要重启服务
- 已登录的用户不受影响（Token仍然有效）

### Q3: 可以在前端使用AppSecret吗？

A: **绝对不可以！** AppSecret只能在后端使用，前端只需要传递code。

### Q4: 测试环境可以不配置AppSecret吗？

A: 可以使用方案2的开发模式，但生产环境必须配置真实的AppSecret。

## ✅ 解决后的效果

配置正确后：
- ✅ 登录接口返回200状态码
- ✅ 成功获取用户信息
- ✅ 生成有效的JWT Token
- ✅ 小程序可以正常登录
- ✅ 可以调用需要认证的API

## 🔄 下一步

1. **配置AppSecret**
   - 从微信公众平台获取
   - 更新 `.env` 文件
   - 重启服务

2. **测试登录流程**
   - 小程序登录
   - Token获取
   - API调用

3. **开发其他功能**
   - 用户信息管理
   - 纪念馆功能
   - 祭扫功能

**配置正确的AppSecret后，登录功能就可以正常工作了！** ✅
