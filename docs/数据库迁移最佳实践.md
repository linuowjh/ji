# æ•°æ®åº“è¿ç§»æœ€ä½³å®è·µ

## é—®é¢˜è¯´æ˜

### åŸæ¥çš„é—®é¢˜

ä¹‹å‰åœ¨ `InitMySQL` å‡½æ•°ä¸­æ¯æ¬¡å¯åŠ¨æœåŠ¡éƒ½ä¼šæ‰§è¡Œ `AutoMigrate`ï¼š

```go
func InitMySQL(cfg config.MySQLConfig) (*gorm.DB, error) {
    // ... è¿æ¥æ•°æ®åº“
    
    // âŒ æ¯æ¬¡å¯åŠ¨éƒ½æ‰§è¡Œ
    err = db.AutoMigrate(
        &models.User{},
        &models.Memorial{},
        // ... æ‰€æœ‰æ¨¡å‹
    )
    
    return db, nil
}
```

### å­˜åœ¨çš„é—®é¢˜

1. **å¯åŠ¨é€Ÿåº¦æ…¢**
   - æ¯æ¬¡å¯åŠ¨éƒ½æ£€æŸ¥æ‰€æœ‰è¡¨ç»“æ„
   - éœ€è¦æŸ¥è¯¢å¤§é‡çš„æ•°æ®åº“å…ƒæ•°æ®
   - å½±å“æœåŠ¡å¯åŠ¨æ—¶é—´

2. **ä¸å¯æ§çš„è¿ç§»**
   - ç”Ÿäº§ç¯å¢ƒå¯èƒ½æ„å¤–ä¿®æ”¹è¡¨ç»“æ„
   - æ— æ³•å®¡æŸ¥è¿ç§»æ“ä½œ
   - éš¾ä»¥å›æ»š

3. **é‡å¤æ“ä½œ**
   - è¡¨ç»“æ„æ²¡å˜åŒ–æ—¶ä»ç„¶æ£€æŸ¥
   - æµªè´¹æ•°æ®åº“èµ„æº
   - äº§ç”Ÿå¤§é‡SQLæ—¥å¿—

## è§£å†³æ–¹æ¡ˆ

### 1. ç§»é™¤è‡ªåŠ¨è¿ç§»

å·²ä» `InitMySQL` ä¸­ç§»é™¤ `AutoMigrate` è°ƒç”¨ã€‚

### 2. ä½¿ç”¨ä¸“é—¨çš„è¿ç§»å‘½ä»¤

#### æ–¹æ³•1ï¼šä½¿ç”¨è¿ç§»å·¥å…·ï¼ˆæ¨èï¼‰

```bash
# æ‰§è¡Œæ•°æ®åº“è¿ç§»
go run cmd/migrate/main.go -action=migrate

# æ’å…¥ç§å­æ•°æ®
go run cmd/migrate/main.go -action=seed

# é‡ç½®æ•°æ®åº“ï¼ˆå±é™©ï¼ï¼‰
go run cmd/migrate/main.go -action=reset
```

#### æ–¹æ³•2ï¼šå¯åŠ¨æ—¶å¸¦å‚æ•°

```bash
# å¯åŠ¨æœåŠ¡å¹¶æ‰§è¡Œè¿ç§»
go run cmd/server/main.go -migrate

# å¯åŠ¨æœåŠ¡ã€è¿ç§»å¹¶æ’å…¥ç§å­æ•°æ®
go run cmd/server/main.go -migrate -seed
```

#### æ–¹æ³•3ï¼šåªå¯åŠ¨æœåŠ¡ï¼ˆæ­£å¸¸æ¨¡å¼ï¼‰

```bash
# ä¸æ‰§è¡Œä»»ä½•è¿ç§»ï¼Œç›´æ¥å¯åŠ¨
go run cmd/server/main.go
```

## è¿ç§»å·¥ä½œæµç¨‹

### å¼€å‘ç¯å¢ƒ

#### é¦–æ¬¡å¯åŠ¨

```bash
# 1. åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
go run cmd/createdb/main.go

# 2. æ‰§è¡Œè¿ç§»
go run cmd/migrate/main.go -action=migrate

# 3. æ’å…¥æµ‹è¯•æ•°æ®ï¼ˆå¯é€‰ï¼‰
go run cmd/migrate/main.go -action=seed

# 4. å¯åŠ¨æœåŠ¡
go run cmd/server/main.go
```

#### æ—¥å¸¸å¼€å‘

```bash
# æ¨¡å‹æœ‰å˜åŒ–æ—¶ï¼Œé‡æ–°è¿ç§»
go run cmd/migrate/main.go -action=migrate

# å¯åŠ¨æœåŠ¡ï¼ˆä¸éœ€è¦è¿ç§»ï¼‰
go run cmd/server/main.go
```

### ç”Ÿäº§ç¯å¢ƒ

#### éƒ¨ç½²æµç¨‹

```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -h host -u user -p database > backup.sql

# 2. æ‰§è¡Œè¿ç§»ï¼ˆåœ¨ç»´æŠ¤çª—å£ï¼‰
go run cmd/migrate/main.go -action=migrate

# 3. éªŒè¯è¿ç§»ç»“æœ
# æ£€æŸ¥è¡¨ç»“æ„ã€ç´¢å¼•ç­‰

# 4. å¯åŠ¨æœåŠ¡
go run cmd/server/main.go
```

#### å›æ»šç­–ç•¥

å¦‚æœè¿ç§»å‡ºç°é—®é¢˜ï¼š

```bash
# 1. åœæ­¢æœåŠ¡
# 2. æ¢å¤æ•°æ®åº“å¤‡ä»½
mysql -h host -u user -p database < backup.sql
# 3. å›æ»šä»£ç 
# 4. é‡æ–°å¯åŠ¨æœåŠ¡
```

## è¿ç§»å‘½ä»¤è¯¦è§£

### cmd/migrate/main.go

è¿™æ˜¯ä¸“é—¨çš„è¿ç§»å·¥å…·ï¼Œæ”¯æŒä»¥ä¸‹æ“ä½œï¼š

```bash
# æŸ¥çœ‹å¸®åŠ©
go run cmd/migrate/main.go -h

# æ‰§è¡Œè¿ç§»
go run cmd/migrate/main.go -action=migrate

# æ’å…¥ç§å­æ•°æ®
go run cmd/migrate/main.go -action=seed

# é‡ç½®æ•°æ®åº“ï¼ˆåˆ é™¤æ‰€æœ‰æ•°æ®ï¼‰
go run cmd/migrate/main.go -action=reset
```

### cmd/server/main.go

æœåŠ¡å™¨å¯åŠ¨æ”¯æŒè¿ç§»å‚æ•°ï¼š

```bash
# åªå¯åŠ¨æœåŠ¡
go run cmd/server/main.go

# å¯åŠ¨å‰æ‰§è¡Œè¿ç§»
go run cmd/server/main.go -migrate

# å¯åŠ¨å‰æ‰§è¡Œè¿ç§»å’Œç§å­æ•°æ®
go run cmd/server/main.go -migrate -seed

# é‡ç½®æ•°æ®åº“ï¼ˆå±é™©ï¼ï¼‰
go run cmd/server/main.go -reset
```

## æ€§èƒ½å¯¹æ¯”

### ä¿®æ”¹å‰ï¼ˆæ¯æ¬¡å¯åŠ¨éƒ½è¿ç§»ï¼‰

```
å¯åŠ¨æ—¶é—´: ~5-10ç§’
- è¿æ¥æ•°æ®åº“: 1ç§’
- AutoMigrateæ£€æŸ¥: 3-8ç§’
- å¯åŠ¨HTTPæœåŠ¡: 1ç§’
```

### ä¿®æ”¹åï¼ˆæŒ‰éœ€è¿ç§»ï¼‰

```
å¯åŠ¨æ—¶é—´: ~2ç§’
- è¿æ¥æ•°æ®åº“: 1ç§’
- å¯åŠ¨HTTPæœåŠ¡: 1ç§’
```

**å¯åŠ¨é€Ÿåº¦æå‡ 60-80%ï¼** ğŸš€

## æœ€ä½³å®è·µ

### 1. å¼€å‘ç¯å¢ƒ

âœ… **æ¨èåšæ³•**ï¼š
```bash
# æ¨¡å‹å˜åŒ–æ—¶æ‰‹åŠ¨è¿ç§»
go run cmd/migrate/main.go -action=migrate

# æ­£å¸¸å¯åŠ¨æœåŠ¡
go run cmd/server/main.go
```

âŒ **ä¸æ¨è**ï¼š
```bash
# æ¯æ¬¡å¯åŠ¨éƒ½è¿ç§»ï¼ˆæ…¢ï¼‰
go run cmd/server/main.go -migrate
```

### 2. ç”Ÿäº§ç¯å¢ƒ

âœ… **æ¨èåšæ³•**ï¼š
```bash
# éƒ¨ç½²å‰å•ç‹¬æ‰§è¡Œè¿ç§»
go run cmd/migrate/main.go -action=migrate

# éªŒè¯è¿ç§»ç»“æœ
# æ£€æŸ¥æ—¥å¿—ã€æµ‹è¯•åŠŸèƒ½

# å¯åŠ¨æœåŠ¡
go run cmd/server/main.go
```

âŒ **ç»å¯¹ç¦æ­¢**ï¼š
```bash
# å¯åŠ¨æ—¶è‡ªåŠ¨è¿ç§»ï¼ˆå±é™©ï¼ï¼‰
go run cmd/server/main.go -migrate
```

### 3. CI/CDæµç¨‹

```yaml
# ç¤ºä¾‹ï¼šGitHub Actions
steps:
  - name: Run migrations
    run: go run cmd/migrate/main.go -action=migrate
    
  - name: Run tests
    run: go test ./...
    
  - name: Build
    run: go build -o server cmd/server/main.go
    
  - name: Deploy
    run: ./deploy.sh
```

## è¿ç§»å®‰å…¨æ£€æŸ¥æ¸…å•

éƒ¨ç½²å‰æ£€æŸ¥ï¼š

- [ ] å·²å¤‡ä»½æ•°æ®åº“
- [ ] åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»
- [ ] æ£€æŸ¥è¿ç§»æ—¥å¿—æ— é”™è¯¯
- [ ] éªŒè¯è¡¨ç»“æ„æ­£ç¡®
- [ ] éªŒè¯ç´¢å¼•å·²åˆ›å»º
- [ ] éªŒè¯å¤–é”®çº¦æŸæ­£ç¡®
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- [ ] é€šçŸ¥ç›¸å…³äººå‘˜

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿ç§»ï¼Ÿ

A: 
- **æ€§èƒ½**ï¼šæ¯æ¬¡å¯åŠ¨éƒ½æ£€æŸ¥è¡¨ç»“æ„å¾ˆæ…¢
- **å®‰å…¨**ï¼šç”Ÿäº§ç¯å¢ƒä¸åº”è¯¥è‡ªåŠ¨ä¿®æ”¹è¡¨ç»“æ„
- **å¯æ§**ï¼šè¿ç§»åº”è¯¥æ˜¯æœ‰æ„è¯†çš„æ“ä½œï¼Œè€Œä¸æ˜¯è‡ªåŠ¨çš„

### Q2: å¼€å‘æ—¶æ¯æ¬¡éƒ½è¦æ‰‹åŠ¨è¿ç§»å—ï¼Ÿ

A: 
- æ¨¡å‹æ²¡å˜åŒ–æ—¶ä¸éœ€è¦è¿ç§»
- åªæœ‰ä¿®æ”¹äº†æ¨¡å‹å®šä¹‰æ‰éœ€è¦è¿ç§»
- å¯ä»¥ä½¿ç”¨ `-migrate` å‚æ•°æ–¹ä¾¿å¼€å‘

### Q3: å¦‚ä½•çŸ¥é“æ˜¯å¦éœ€è¦è¿ç§»ï¼Ÿ

A: 
- ä¿®æ”¹äº† `internal/models/` ä¸­çš„æ¨¡å‹
- æ·»åŠ äº†æ–°çš„å­—æ®µ
- ä¿®æ”¹äº†å­—æ®µç±»å‹æˆ–çº¦æŸ
- æ·»åŠ äº†æ–°çš„æ¨¡å‹

### Q4: è¿ç§»å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

A: 
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
2. æ£€æŸ¥æ¨¡å‹å®šä¹‰
3. æ£€æŸ¥æ•°æ®åº“æƒé™
4. å¿…è¦æ—¶æ‰‹åŠ¨ä¿®å¤
5. é‡æ–°æ‰§è¡Œè¿ç§»

### Q5: å¯ä»¥å›æ»šè¿ç§»å—ï¼Ÿ

A: 
- GORMçš„AutoMigrateä¸æ”¯æŒå›æ»š
- éœ€è¦æ‰‹åŠ¨ç¼–å†™å›æ»šSQL
- æˆ–è€…æ¢å¤æ•°æ®åº“å¤‡ä»½
- å»ºè®®ä½¿ç”¨ä¸“ä¸šçš„è¿ç§»å·¥å…·ï¼ˆå¦‚golang-migrateï¼‰

## è¿›é˜¶ï¼šä½¿ç”¨ä¸“ä¸šè¿ç§»å·¥å…·

å¦‚æœéœ€è¦æ›´å¼ºå¤§çš„è¿ç§»åŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘ï¼š

### golang-migrate

```bash
# å®‰è£…
go install -tags 'mysql' github.com/golang-migrate/migrate/v4/cmd/migrate@latest

# åˆ›å»ºè¿ç§»
migrate create -ext sql -dir migrations -seq create_users_table

# æ‰§è¡Œè¿ç§»
migrate -path migrations -database "mysql://user:pass@tcp(host:port)/db" up

# å›æ»š
migrate -path migrations -database "mysql://user:pass@tcp(host:port)/db" down
```

### ä¼˜ç‚¹
- æ”¯æŒç‰ˆæœ¬æ§åˆ¶
- æ”¯æŒå›æ»š
- æ”¯æŒå¤šç§æ•°æ®åº“
- è¿ç§»å†å²è®°å½•

## æ€»ç»“

### ä¿®æ”¹å†…å®¹

- âœ… ç§»é™¤äº† `InitMySQL` ä¸­çš„ `AutoMigrate`
- âœ… ä¿ç•™äº†ä¸“é—¨çš„è¿ç§»å·¥å…·
- âœ… æ”¯æŒå¯åŠ¨æ—¶å¯é€‰è¿ç§»
- âœ… æé«˜äº†å¯åŠ¨é€Ÿåº¦

### ä½¿ç”¨å»ºè®®

**å¼€å‘ç¯å¢ƒ**ï¼š
```bash
# æ¨¡å‹å˜åŒ–æ—¶
go run cmd/migrate/main.go -action=migrate

# æ—¥å¸¸å¯åŠ¨
go run cmd/server/main.go
```

**ç”Ÿäº§ç¯å¢ƒ**ï¼š
```bash
# éƒ¨ç½²æ—¶å•ç‹¬è¿ç§»
go run cmd/migrate/main.go -action=migrate

# å¯åŠ¨æœåŠ¡
go run cmd/server/main.go
```

**å¿«é€Ÿå¼€å‘**ï¼ˆå¯é€‰ï¼‰ï¼š
```bash
# å¯åŠ¨æ—¶è‡ªåŠ¨è¿ç§»
go run cmd/server/main.go -migrate
```

### æ”¶ç›Š

- ğŸš€ å¯åŠ¨é€Ÿåº¦æå‡ 60-80%
- ğŸ”’ æ›´å®‰å…¨çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- ğŸ¯ æ›´å¯æ§çš„è¿ç§»æµç¨‹
- ğŸ“Š æ›´æ¸…æ™°çš„è¿ç§»æ—¥å¿—

**ç°åœ¨æœåŠ¡å¯åŠ¨ä¼šå¿«å¾ˆå¤šï¼** âš¡
